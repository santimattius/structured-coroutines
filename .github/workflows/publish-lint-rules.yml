name: Publish Lint Rules

on:
  release:
    types: [released, prereleased]
  workflow_dispatch:

jobs:
  publish-lint-rules:
    name: Publish lint-rules to Maven Central
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      # Central Portal token (from https://central.sonatype.com/usertoken). Old OSSRH credentials return 402.
      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.MAVEN_CENTRAL_USERNAME }}" ] || [ -z "${{ secrets.MAVEN_CENTRAL_PASSWORD }}" ]; then
            echo "::error::MAVEN_CENTRAL_USERNAME and MAVEN_CENTRAL_PASSWORD must be set (use a Central Portal token from https://central.sonatype.com/usertoken)."
            exit 1
          fi
          if [ -z "${{ secrets.SIGNING_KEY_ID }}" ] || [ -z "${{ secrets.SIGNING_PASSWORD }}" ] || [ -z "${{ secrets.GPG_KEY_CONTENTS }}" ]; then
            echo "::error::SIGNING_KEY_ID, SIGNING_PASSWORD, and GPG_KEY_CONTENTS must be set in repository secrets."
            exit 1
          fi

      - name: Publish lint-rules to Maven Central (Portal Staging API)
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.SIGNING_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_KEY_CONTENTS }}
          GRADLE_OPTS: -Dorg.gradle.internal.http.connectionTimeout=120000 -Dorg.gradle.internal.http.socketTimeout=120000
        run: |
          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "Publish attempt $attempt of $max_attempts"
            if ./gradlew :lint-rules:publishMavenPublicationToMavenCentralRepository --no-configuration-cache; then
              echo "Publish succeeded."
              break
            fi
            if [ $attempt -lt $max_attempts ]; then
              echo "Attempt $attempt failed. Retrying in 90 seconds..."
              sleep 90
            fi
            attempt=$((attempt + 1))
          done
          if [ $attempt -gt $max_attempts ]; then
            echo "All publish attempts failed."
            exit 1
          fi

      # Required for Gradle maven-publish: upload staging repo to Portal so it can be released (same IP as publish).
      - name: Upload deployment to Central Portal and release
        env:
          PORTAL_USER: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          PORTAL_SECRET: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
        run: |
          NAMESPACE="io.github.santimattius"
          AUTH=$(echo -n "${PORTAL_USER}:${PORTAL_SECRET}" | base64)
          RESP=$(curl -s -w "\n%{http_code}" -X POST \
            "https://ossrh-staging-api.central.sonatype.com/manual/upload/defaultRepository/${NAMESPACE}?publishing_type=automatic" \
            -H "Authorization: Bearer ${AUTH}")
          HTTP_CODE=$(echo "$RESP" | tail -n1)
          BODY=$(echo "$RESP" | sed '$d')
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "Deployment uploaded to Central Portal (auto-release to Maven Central requested)."
            echo "$BODY"
          else
            echo "::error::Portal upload failed (HTTP $HTTP_CODE). Check token at https://central.sonatype.com/usertoken"
            echo "$BODY"
            exit 1
          fi
