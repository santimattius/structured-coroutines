name: Publish Lint Rules

on:
  release:
    types: [released, prereleased]
  workflow_dispatch:

jobs:
  publish-lint-rules:
    name: Publish lint-rules to Maven Central
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.MAVEN_CENTRAL_USERNAME }}" ] || [ -z "${{ secrets.MAVEN_CENTRAL_PASSWORD }}" ]; then
            echo "::error::MAVEN_CENTRAL_USERNAME and MAVEN_CENTRAL_PASSWORD must be set in repository secrets."
            exit 1
          fi
          if [ -z "${{ secrets.SIGNING_KEY_ID }}" ] || [ -z "${{ secrets.SIGNING_PASSWORD }}" ] || [ -z "${{ secrets.GPG_KEY_CONTENTS }}" ]; then
            echo "::error::SIGNING_KEY_ID, SIGNING_PASSWORD, and GPG_KEY_CONTENTS must be set in repository secrets."
            exit 1
          fi

      - name: Publish lint-rules to Maven Central
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.SIGNING_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_KEY_CONTENTS }}
          GRADLE_OPTS: -Dorg.gradle.internal.http.connectionTimeout=120000 -Dorg.gradle.internal.http.socketTimeout=120000
        run: |
          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "Publish attempt $attempt of $max_attempts"
            if ./gradlew :lint-rules:publishMavenPublicationToMavenCentralRepository --no-configuration-cache; then
              echo "Publish succeeded."
              exit 0
            fi
            if [ $attempt -lt $max_attempts ]; then
              echo "Attempt $attempt failed (e.g. 504 Gateway Time-out). Retrying in 90 seconds..."
              sleep 90
            fi
            attempt=$((attempt + 1))
          done
          echo "All publish attempts failed."
          exit 1
